"use strict";(self.webpackChunknodebb=self.webpackChunknodebb||[]).push([[7913,6918],{47913:(t,e,a)=>{var i,o;i=[a(74344),a(7927)],void 0===(o=function(t,e){var i,o={};function n(){i&&(clearTimeout(i),i=0)}function r(t){return parseInt(t,10)>0?localStorage:sessionStorage}function s(t,e,a){if(d(app.user.uid?"localStorage":"sessionStorage")&&a&&a.save_id&&t.length){const d=t.find("input.title"),l=d&&d.val();var i=t.find("textarea").val(),n=r(app.user.uid);if(a.hasOwnProperty("cid")&&!a.save_id.endsWith(":cid:"+a.cid)&&(o.removeDraft(a.save_id),a.save_id=a.save_id.replace(/cid:\d+$/,"cid:"+a.cid)),i.length||l&&l.length){if(n.setItem(a.save_id,i),n.setItem(`${a.save_id}:uuid`,t.attr("data-uuid")),a.hasOwnProperty("cid")){const e=t.find("input.tags").val();n.setItem(a.save_id+":tags",e),n.setItem(a.save_id+":title",l)}if(!app.user.uid){var s=t.find("input.handle").val();n.setItem(a.save_id+":handle",s)}$(window).trigger("action:composer.drafts.save",{storage:n,postData:a,postContainer:t}),e.toggleClass("active",!0)}else o.removeDraft(a.save_id)}}function d(t){var e;try{e=window[t];var a="__storage_test__";return e.setItem(a,a),e.removeItem(a),!0}catch(t){return t instanceof DOMException&&(22===t.code||1014===t.code||"QuotaExceededError"===t.name||"NS_ERROR_DOM_QUOTA_REACHED"===t.name)&&e&&0!==e.length}}return o.init=function(t,e){var a=t.find(".draft-icon");function r(){n(),i=setTimeout((function(){s(t,a,e)}),1e3)}t.on("keyup","textarea, input.handle, input.title",r),t.on("click",'input[type="checkbox"]',r),t.on("thumb.uploaded",r),a.on("animationend",(function(){$(this).toggleClass("active",!1)})),$(window).on("unload",(function(){var t=[];try{t=localStorage.getItem("drafts:open"),t=JSON.parse(t)||[]}catch(e){console.warn("[composer/drafts] Could not read list of open/available drafts"),t=[]}t.length&&t.forEach((function(t){o.updateVisibility("open",t)}))})),o.migrateGuest(),o.migrateThumbs(...arguments)},o.getDraft=function(t){return console.warn("[composer/drafts] drafts.getDraft is deprecated! Use drafts.get() instead."),localStorage.getItem(t)},o.get=function(t){var e=t.split(":")[1],a=r(e),i={text:a.getItem(t)};return["cid","title","tags","uuid"].forEach((function(e){const o=a.getItem(t+":"+e);o&&(i[e]=o)})),parseInt(e,10)||(i.handle=a.getItem(t+":handle")),$(window).trigger("action:composer.drafts.get",{save_id:t,draft:i,storage:a}),i},o.removeDraft=function(t){if(t){n(),o.updateVisibility("available",t),o.updateVisibility("open",t);var e=r(t.split(":")[1]);Object.keys(e).filter((e=>e.startsWith(t))).forEach((t=>e.removeItem(t)))}},o.updateVisibility=function(t,e,a){if(d(app.user.uid?"localStorage":"sessionStorage")&&e){var i=[];try{i=(i=localStorage.getItem("drafts:"+t))?JSON.parse(i):[]}catch(t){console.warn("[composer/drafts] Could not read list of open drafts"),i=[]}var o=i.indexOf(e);a&&-1===o?i.push(e):a||-1===o||i.splice(o,1),localStorage.setItem("drafts:"+t,JSON.stringify(i))}},o.migrateGuest=function(){if(d("localStorage")&&app.user.uid){var t=/^composer:\d+:\w+:\d+(:\w+)?$/,e=Object.keys(sessionStorage).filter((function(e){return t.test(e)})),a=new Set([]),i=e.map((function(t){var e=t.split(":");return e[1]=app.user.uid,a.add(e.slice(0,4).join(":")),e.join(":")}));return e.forEach((function(t,e){localStorage.setItem(i[e],sessionStorage.getItem(t)),sessionStorage.removeItem(t)})),a.forEach((function(t){o.updateVisibility("available",t,1)})),a}},o.migrateThumbs=function(e,i){const n=e.attr("data-uuid"),r=o.get(i.save_id);r&&r.uuid&&t.put(`/topics/${r.uuid}/thumbs`,{tid:n}).then((()=>{Promise.all([a.e(6177),a.e(2526),a.e(4074),a.e(2143),a.e(5482),a.e(1521),a.e(2023)]).then((function(){var t=[a(44541)];(function(t){t.updateThumbCount(n,e)}).apply(null,t)})).catch(a.oe)}))},o.loadOpen=function(){if(!ajaxify.data.template.login&&!ajaxify.data.template.register){var i,n=[];try{i=localStorage.getItem("drafts:available"),n=localStorage.getItem("drafts:open"),i=JSON.parse(i)||[],n=JSON.parse(n)||[]}catch(t){console.warn("[composer/drafts] Could not read list of open/available drafts"),i=[],n=[]}i.length&&app.user&&0!==app.user.uid&&i.forEach((function(i){if(i){var r=i.split(":"),s=r[1],d=r[2],l=r[3],c=o.get(i);if(-1===n.indexOf(i)&&parseInt(app.user.uid,10)===parseInt(s,10))return!c||c.text&&c.title&&!c.text.title&&!c.text.length?(o.updateVisibility("available",i),void o.updateVisibility("open",i)):void Promise.all([a.e(6177),a.e(2526),a.e(4074),a.e(2143),a.e(5482),a.e(1521),a.e(2023)]).then((function(){var i=[a(44541)];(function(a){"cid"===d?a.newTopic({cid:l,title:utils.escapeHTML(c.title),body:c.text,tags:[]}):"tid"===d?t.get("/topics/"+l,{},(function(t,i){if(t)return e.error(t);a.newReply(l,void 0,i.title,c.text)})):"pid"===d&&a.editPost(l)}).apply(null,i)})).catch(a.oe)}}))}},o}.apply(e,i))||(t.exports=o)}}]);