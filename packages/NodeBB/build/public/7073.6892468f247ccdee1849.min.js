"use strict";(self.webpackChunknodebb=self.webpackChunknodebb||[]).push([[7073],{7073:(e,t,n)=>{var s,i;s=[n(32230),n(66603),n(85233),n(7927)],void 0===(i=function(e,t,n,s){const i={current:{}};function a(e){const t=e.in||"titles",i=e.by||"";let a=e.term.replace(/^[ ?#]*/,"");try{a=encodeURIComponent(a)}catch(e){return s.error("[[error:invalid-search-term]]")}const r={term:a,in:t};return e.matchWords&&(r.matchWords=e.matchWords),i&&i.length&&("posts"===t||"titles"===t||"titlesposts"===t)&&(r.by=i),e.categories&&e.categories.length&&(r.categories=e.categories,e.searchChildren&&(r.searchChildren=e.searchChildren)),e.hasTags&&e.hasTags.length&&(r.hasTags=e.hasTags),parseInt(e.replies,10)>0&&(r.replies=e.replies,r.repliesFilter=e.repliesFilter||"atleast"),e.timeRange&&(r.timeRange=e.timeRange,r.timeFilter=e.timeFilter||"newer"),e.sortBy&&(r.sortBy=e.sortBy,r.sortDirection=e.sortDirection),e.showAs&&(r.showAs=e.showAs),e.searchOnly&&(r.searchOnly=e.searchOnly),n.fire("action:search.createQueryString",{query:r,data:e}),decodeURIComponent($.param(r))}return i.init=function(e){if(!config.searchEnabled)return;e=e||{in:config.searchDefaultInQuick||"titles"};const t=$("#search-button"),a=$("#search-fields"),r=$("#search-fields input"),c=$("#quick-search-container");$("#search-form .advanced-search-link").off("mousedown").on("mousedown",(function(){ajaxify.go("/search")})),$("#search-form").off("submit").on("submit",(function(){r.blur()})),r.off("blur").on("blur",(function(){setTimeout((function(){r.is(":focus")||(a.addClass("hidden"),t.removeClass("hidden"))}),200)})),r.off("focus");const o={inputEl:r,resultEl:c};i.enableQuickSearch({searchOptions:e,searchElements:o}),t.off("click").on("click",(function(e){return config.loggedIn||app.user.privileges["search:content"]?(e.stopPropagation(),i.showAndFocusInput(),!1):(s.alert({message:"[[error:search-requires-login]]",timeout:3e3}),ajaxify.go("login"),!1)})),$("#search-form").off("submit").on("submit",(function(){const t=$(this).find("input"),s=i.getSearchPreferences();return s.term=t.val(),s.in=e.in,n.fire("action:search.submit",{searchOptions:s,searchElements:o}),i.query(s,(function(){t.val("")})),!1}))},i.enableQuickSearch=function(t){if(!config.searchEnabled||!app.user.privileges["search:content"])return;const s=Object.assign({in:config.searchDefaultInQuick||"titles"},t.searchOptions),a=t.searchElements.resultEl,r=t.searchElements.inputEl;let c=r.val();const o=a.find(".filter-category");function h(){ajaxify.data.template.category&&e.translate("[[search:search-in-category, "+ajaxify.data.name+"]]",(function(e){const t=$("<div></div>").html(e).text();o.find(".name").text(t)})),o.toggleClass("hidden",!ajaxify.data.template.category)}function l(){t.searchOptions=Object.assign({},s),t.searchOptions.term=r.val(),h(),ajaxify.data.template.category&&o.find('input[type="checkbox"]').is(":checked")&&(t.searchOptions.categories=[ajaxify.data.cid],t.searchOptions.searchChildren=!0),a.removeClass("hidden").find(".quick-search-results-container").html(""),a.find(".loading-indicator").removeClass("hidden"),n.fire("action:search.quick.start",t),t.searchOptions.searchOnly=1,i.api(t.searchOptions,(function(e){if(a.find(".loading-indicator").addClass("hidden"),!e.posts||t.hideOnNoMatches&&!e.posts.length)return a.addClass("hidden").find(".quick-search-results-container").html("");e.posts.forEach((function(e){const t=$("<div>"+e.content+"</div>").text(),n=r.val().toLowerCase().replace(/^in:topic-\d+/,""),s=Math.max(0,t.toLowerCase().indexOf(n)-40);e.snippet=utils.escapeHTML((s>0?"...":"")+t.slice(s,s+80)+(t.length-s>80?"...":""))})),app.parseAndTranslate("partials/quick-search-results",e,(function(s){s.length&&s.find(".timeago").timeago(),a.toggleClass("hidden",!s.length||!r.is(":focus")).find(".quick-search-results-container").html(s.length?s:"");const c=a.find(".quick-search-results .quick-search-title, .quick-search-results .snippet");i.highlightMatches(t.searchOptions.term,c),n.fire("action:search.quick.complete",{data:e,options:t})}))}))}a.find('.filter-category input[type="checkbox"]').on("change",(function(){r.focus(),l()})),r.off("keyup").on("keyup",utils.debounce((function(){if(r.val().length<3)return a.addClass("hidden"),void(c=r.val());if(r.val()!==c){if(c=r.val(),!r.is(":focus"))return a.addClass("hidden");l()}}),500));let u=!1;a.on("mousedown",(function(){$(window).one("mouseup",(function(){a.addClass("hidden")})),u=!0})),r.on("blur",(function(){r.is(":focus")||u||a.hasClass("hidden")||a.addClass("hidden")}));let f=!1;n.on("action:ajaxify.end",(function(){ajaxify.isCold()||(f=!0)})),r.on("focus",(function(){u=!1;const e=r.val();c=e,e&&a.find("#quick-search-results").children().length&&(h(),f?(l(),f=!1):a.removeClass("hidden"),r[0].setSelectionRange(e.startsWith("in:topic")?e.indexOf(" ")+1:0,e.length))})),r.off("refresh").on("refresh",(function(){l()}))},i.showAndFocusInput=function(){$("#search-fields").removeClass("hidden"),$("#search-button").addClass("hidden"),$("#search-fields input").focus()},i.query=function(e,t){t=t||function(){},ajaxify.go("search?"+a(e)),t()},i.api=function(e,t){const n=config.relative_path+"/api/search?"+a(e);e.searchOnly=void 0;const s=config.relative_path+"/search?"+a(e);$.get(n,(function(e){e.url=s,t(e)}))},i.getSearchPreferences=function(){try{return JSON.parse(t.getItem("search-preferences")||"{}")}catch(e){return{}}},i.highlightMatches=function(e,t){if(!e||!t.length)return;const n=(e=utils.escapeHTML(e.replace(/^"/,"").replace(/"$/,"").trim())).split(" ").map((function(e){return utils.escapeRegexChars(e)})).join("|"),s=new RegExp("("+n+")","gi");t.each((function(){const e=$(this),t=[];e.find("*").each((function(){$(this).after("\x3c!-- "+t.length+" --\x3e"),t.push($("<div></div>").append($(this)))})),e.html(e.html().replace(s,(function(e,t){return'<strong class="search-match">'+t+"</strong>"}))),t.forEach((function(t,n){e.html(e.html().replace("\x3c!-- "+n+" --\x3e",(function(){return t.html()})))}))})),$(".search-result-text").find("img:not(.not-responsive)").addClass("img-responsive")},i}.apply(t,s))||(e.exports=i)}}]);