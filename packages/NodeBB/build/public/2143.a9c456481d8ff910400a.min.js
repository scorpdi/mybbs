"use strict";(self.webpackChunknodebb=self.webpackChunknodebb||[]).push([[2143],{22905:(e,t,o)=>{var a,n;a=[o(7927)],void 0===(n=function(e){const t={init:function(t,o){let a=null;(o=o||{}).privilege=o.privilege||"topics:read",o.states=o.states||["watching","notwatching","ignoring"];let n=[];Array.isArray(o.localCategories)&&(n=o.localCategories.map((e=>({...e})))),o.selectedCids=o.selectedCids||ajaxify.data.selectedCids||[];const i=t.find('[component="category-selector-search"]');if(!i.length)return;const r=i.parent('[component="category/dropdown"]').length>0||i.parent('[component="category-selector"]').length>0;function s(e){app.parseAndTranslate(o.template,{categoryItems:e.slice(0,200),selectedCategory:ajaxify.data.selectedCategory,allCategoriesUrl:ajaxify.data.allCategoriesUrl},(function(o){t.find('[component="category/list"]').replaceWith(o.find('[component="category/list"]')),t.find('[component="category/list"] [component="category/no-matches"]').toggleClass("hidden",!!e.length)}))}t.on("show.bs.dropdown",(function(){function c(){const t=i.find("input").val();var r,c;t.length>1||!t&&!a?(r=t,c=function(e){a=a||e,s(e)},socket.emit("categories.categorySearch",{search:r,query:utils.params(),parentCid:o.parentCid||0,selectedCids:o.selectedCids,privilege:o.privilege,states:o.states,showLinks:o.showLinks},(function(t,o){if(t)return e.error(t);c(n.concat(o))}))):!t&&a&&(a.forEach((function(e){e.selected=o.selectedCids.includes(e.cid)})),s(a))}r&&(t.find(".dropdown-toggle").addClass("hidden"),i.removeClass("hidden")),i.on("click",(function(e){e.preventDefault(),e.stopPropagation()})),i.find("input").val("").on("keyup",utils.debounce(c,300)),c()})),t.on("shown.bs.dropdown",(function(){i.find("input").focus()})),t.on("hide.bs.dropdown",(function(){r&&(t.find(".dropdown-toggle").removeClass("hidden"),i.addClass("hidden")),i.off("click"),i.find("input").off("keyup")}))}};return t}.apply(t,a))||(e.exports=n)},50548:(e,t,o)=>{var a,n;a=[o(22905),o(31369),o(85233)],void 0===(n=function(e,t,o){const a={init:function(t,a){if(!t||!t.length)return;const n=(a=a||{}).onSelect||function(){};a.states=a.states||["watching","notwatching","ignoring"],a.template="partials/category-selector",o.fire("action:category.selector.options",{el:t,options:a}),e.init(t,a);const i={el:t,selectedCategory:null};t.on("click","[data-cid]",(function(){const e=$(this);if(e.hasClass("disabled"))return!1;i.selectCategory(e.attr("data-cid")),n(i.selectedCategory)}));const r=i.el.find('[component="category-selector-selected"]').html();return i.selectCategory=function(e){const t=i.el.find('[data-cid="'+e+'"]');i.selectedCategory={cid:e,name:t.attr("data-name")},t.length?i.el.find('[component="category-selector-selected"]').html(t.find('[component="category-markup"]').html()):i.el.find('[component="category-selector-selected"]').html(r)},i.getSelectedCategory=function(){return i.selectedCategory},i.getSelectedCid=function(){return i.selectedCategory?i.selectedCategory.cid:0},i},modal:function(e){(e=e||{}).onSelect=e.onSelect||function(){},e.onSubmit=e.onSubmit||function(){},app.parseAndTranslate("admin/partials/categories/select-category",{message:e.message},(function(o){const n=t.dialog({title:e.title||"[[modules:composer.select_category]]",message:o,buttons:{save:{label:"[[global:select]]",className:"btn-primary",callback:r}}}),i=a.init(n.find('[component="category-selector"]'),e);function r(t){return t.preventDefault(),i.selectedCategory&&(e.onSubmit(i.selectedCategory),n.modal("hide")),!1}e.openOnLoad&&n.on("shown.bs.modal",(function(){n.find(".dropdown-toggle").dropdown("toggle")})),n.find("form").on("submit",r)}))}};return a}.apply(t,a))||(e.exports=n)},98755:(e,t,o)=>{var a,n;a=[o(50548),o(27145),o(74344)],void 0===(n=function(e,t,a){var n,i={};function r(e){e.find('.category-list-container [component="category-selector"]').toggleClass("dropup",e.outerHeight()<$(window).height()/2)}function s(e,o){if(o){var a=e.attr("data-uuid");t.update("composer",a,{image:o.backgroundImage,"background-color":o.bgColor,icon:o.icon&&o.icon.slice(3)})}}async function c(e,t,a){t.cid=a.cid;const n=await window.fetch(`${config.relative_path}/api/category/${a.cid}`).then((e=>e.json()));t.category=n,s(e,n),o.e(3913).then((function(){var i=[o(98166),o(88186)];(function(o,i){o.onChangeCategory(n),i.onChangeCategory(e,t,a.cid,n),$(window).trigger("action:composer.changeCategory",{postContainer:e,postData:t,selectedCategory:a,categoryData:n})}).apply(null,i)})).catch(o.oe)}return i.init=function(t,o){var a=t.find(".category-list-container");a.length&&(t.on("action:composer.resize",(function(){r(t)})),i.updateTaskbar(t,o),(n=e.init(a.find('[component="category-selector"]'),{privilege:"topics:create",states:["watching","notwatching","ignoring"],onSelect:function(e){o.hasOwnProperty("cid")&&c(t,o,e)}}))&&(o.cid&&o.category?n.selectedCategory={cid:o.cid,name:o.category.name}:ajaxify.data.template.compose&&ajaxify.data.selectedCategory&&(n.selectedCategory={cid:ajaxify.data.cid,name:ajaxify.data.selectedCategory}),t.find(".category-name").translateText(n.selectedCategory?n.selectedCategory.name:"[[modules:composer.select_category]]").on("click",(function(){e.modal({privilege:"topics:create",states:["watching","notwatching","ignoring"],openOnLoad:!0,showLinks:!1,onSelect:function(e){t.find(".category-name").text(e.name),n.selectCategory(e.cid),o.hasOwnProperty("cid")&&c(t,o,e)}})})),r(t)))},i.getSelectedCid=function(){var e;return n&&(e=n.getSelectedCategory()),e?e.cid:0},i.updateTaskbar=function(e,t){parseInt(t.cid,10)&&a.get(`/categories/${t.cid}`,{}).then((function(t){s(e,t)}))},i}.apply(t,a))||(e.exports=n)},22143:(e,t,o)=>{var a,n;a=[o(83713),o(98755),o(32230),o(7927),o(33371),o(86569)],void 0===(n=function(e,t,o,a,n){var i={inProgress:{}},r="";function s(e){e.wrap("<form />").closest("form").get(0).reset(),e.unwrap()}function c(n){var s=[...n.files],c=n.post_uuid,l=$('.composer[data-uuid="'+c+'"]'),d=l.find("textarea"),u=d.val(),p=l.find("#fileForm"),f=!1;p.attr("action",config.relative_path+n.route);var g=t.getSelectedCid();!g&&ajaxify.data.cid&&(g=ajaxify.data.cid);var m=0,h=!1;for(m=0;m<s.length;++m)if((h=s[m].type.match(/image./))&&!app.user.privileges["upload:post:image"]||!h&&!app.user.privileges["upload:post:file"])return a.error("[[error:no-privileges]]");var y,v,b,C=[];for(m=0;m<s.length;++m){if(C.push(m+"_"+Date.now()+"_"+(n.fileNames?n.fileNames[m]:s[m].name)),h=s[m].type.match(/image./),s[m].size>1024*parseInt(config.maximumFileSize,10))return p[0].reset(),a.error("[[error:file-too-big, "+config.maximumFileSize+"]]");y=u,v=d.getCursorPosition(),b=(h?"!":"")+"["+C[m]+"]("+r+") ",u=y.slice(0,v)+b+y.slice(v)}p.length&&l.find('[data-action="post"]').prop("disabled",!0),d.val(u),$(window).trigger("action:composer.uploadStart",{post_uuid:c,files:C.map((function(e,t){return{filename:e.replace(/^\d+_\d{13}_/,""),isImage:/image./.test(s[t].type)}})),text:r}),p.off("submit").submit((function(){function t(e,t,o){var a;o&&(a=e.replace(/^\d+_\d{13}_/,""));var n=d.val(),i=new RegExp(function(e){return e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")}(e)+"]\\([^)]+\\)","g");d.val(n.replace(i,(a||e)+"]("+t+")")),$(window).trigger("action:composer.uploadUpdate",{post_uuid:c,filename:e,text:t})}return i.inProgress[c]=i.inProgress[c]||[],i.inProgress[c].push(1),n.formData&&n.formData.append("cid",g),$(this).ajaxSubmit({headers:{"x-csrf-token":config.csrf_token},resetForm:!0,clearForm:!0,formData:n.formData,data:{cid:g},error:function(o){f=!0,l.find('[data-action="post"]').prop("disabled",!1);const n=function(e,t){var o=e.responseJSON&&(e.responseJSON.error||e.responseJSON.status&&e.responseJSON.status.message)||"[[error:parse-error]]";return e&&413===e.status&&(o=e.statusText||"Request Entity Too Large"),a.error(o),$(window).trigger("action:composer.uploadError",{post_uuid:t,message:o}),o}(o,c);for(var i=0;i<s.length;++i)t(C[i],n,!0);e.render(l)},uploadProgress:function(e,a,n,i){o.translate("[[modules:composer.uploading, "+i+"%]]",(function(e){if(!f)for(var o=0;o<s.length;++o)t(C[o],e)}))},success:function(o){const a=o.response.images;if(f=!0,a&&a.length)for(var n=0;n<a.length;++n)a[n].filename=C[n].replace(/^\d+_\d{13}_/,""),a[n].isImage=/image./.test(s[n].type),t(C[n],a[n].url,!0);e.render(l),d.focus(),l.find('[data-action="post"]').prop("disabled",!1),$(window).trigger("action:composer.upload",{post_uuid:c,files:a})},complete:function(){p[0].reset(),i.inProgress[c].pop()}}),!1})),p.submit()}return i.initialize=function(e){!function(e){var t=$('.composer[data-uuid="'+e+'"]');n.handleDragDrop({container:t,callback:function(t){c({files:t.files,post_uuid:e,route:"/api/post/upload",formData:t.formData})}})}(e),function(e){var t=$('.composer[data-uuid="'+e+'"]');n.handlePaste({container:t,callback:function(t){c({files:t.files,fileNames:t.fileNames,post_uuid:e,route:"/api/post/upload",formData:t.formData})}})}(e),function(e){$('.composer[data-uuid="'+e+'"]').find("#files").on("change",(function(t){var o=(t.target||{}).files||($(this).val()?[{name:$(this).val(),type:utils.fileMimeType($(this).val())}]:null);o&&c({files:o,post_uuid:e,route:"/api/post/upload"})}))}(e),function(e){var t=$('.composer[data-uuid="'+e+'"]');t.on("click",".topic-thumb-clear-btn",(function(e){t.find("input#topic-thumb-url").val("").trigger("change"),s(t.find("input#topic-thumb-file")),$(this).addClass("hide"),e.preventDefault()})),t.on("paste change keypress","input#topic-thumb-url",(function(){var e=$(this);setTimeout((function(){var o=e.val();o?t.find(".topic-thumb-clear-btn").removeClass("hide"):(s(t.find("input#topic-thumb-file")),t.find(".topic-thumb-clear-btn").addClass("hide")),t.find("img.topic-thumb-preview").attr("src",o)}),100)}))}(e),o.translate("[[modules:composer.uploading, 0%]]",(function(e){r=e}))},i}.apply(t,a))||(e.exports=n)},33371:(e,t,o)=>{var a,n;a=[o(7927)],void 0===(n=function(e){const t={init:function(e){const o=e.uploadFormEl;o.length&&(o.attr("action",config.relative_path+e.route),e.dragDropAreaEl&&t.handleDragDrop({container:e.dragDropAreaEl,callback:function(a){t.ajaxSubmit({uploadForm:o,upload:a,callback:e.callback})}}),e.pasteEl&&t.handlePaste({container:e.pasteEl,callback:function(a){t.ajaxSubmit({uploadForm:o,upload:a,callback:e.callback})}}))},handleDragDrop:function(e){let t=!1;const o=e.container,a=e.container.find(".imagedrop");function n(e){return e.preventDefault(),!1}o.on("dragenter",(function(){t||(a.css("top","0px"),a.css("height",o.height()+"px"),a.css("line-height",o.height()+"px"),a.show(),a.on("dragleave",(function(){a.hide(),a.off("dragleave")})))})),a.on("drop",(function(t){t.preventDefault();const o=t.originalEvent.dataTransfer.files;if(o.length){let t;if(window.FormData){t=new FormData;for(var n=0;n<o.length;++n)t.append("files[]",o[n],o[n].name)}e.callback({files:o,formData:t})}return a.hide(),!1})),$(document).off("dragstart").on("dragstart",(function(){t=!0})).off("dragend").on("dragend, mouseup",(function(){t=!1})),a.on("dragover",n),a.on("dragenter",n)},handlePaste:function(e){e.container.on("paste",(function(t){const o=(t.clipboardData||t.originalEvent.clipboardData||{}).items,a=[],n=[];let i=null;window.FormData&&(i=new FormData),[].forEach.call(o,(function(e){const t=e.getAsFile();if(t){const e=utils.generateUUID()+"-"+t.name;i&&i.append("files[]",t,e),a.push(t),n.push(e)}})),a.length&&e.callback({files:a,fileNames:n,formData:i})}))},ajaxSubmit:function(t){const o=[...t.upload.files];for(let a=0;a<o.length;++a){const n=o[a].type.match(/image./);if(n&&!app.user.privileges["upload:post:image"]||!n&&!app.user.privileges["upload:post:file"])return e.error("[[error:no-privileges]]");if(o[a].size>1024*parseInt(config.maximumFileSize,10))return t.uploadForm[0].reset(),e.error("[[error:file-too-big, "+config.maximumFileSize+"]]")}const a=Date.now();t.uploadForm.off("submit").on("submit",(function(){return $(this).ajaxSubmit({headers:{"x-csrf-token":config.csrf_token},resetForm:!0,clearForm:!0,formData:t.upload.formData,error:function(t){let o=t.responseJSON&&(t.responseJSON.error||t.responseJSON.status&&t.responseJSON.status.message)||"[[error:parse-error]]";t&&413===t.status&&(o=t.statusText||"Request Entity Too Large"),e.error(o),e.remove(a)},uploadProgress:function(t,o,n,i){e.alert({alert_id:a,message:"[[modules:composer.uploading, "+i+"%]]"})},success:function(e){const a=e.response.images;if(a&&a.length)for(var n=0;n<a.length;++n)a[n].filename=o[n].name,a[n].isImage=/image./.test(o[n].type);t.callback(a)},complete:function(){t.uploadForm[0].reset(),setTimeout(e.remove,100,a)}}),!1})),t.uploadForm.submit()}};return t}.apply(t,a))||(e.exports=n)}}]);