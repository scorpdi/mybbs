"use strict";(self.webpackChunknodebb=self.webpackChunknodebb||[]).push([[524,8894,2735,8306,6862],{30524:(e,t,a)=>{var n,o;n=[a(7237),a(32230),a(42441),a(81018),a(18596),a(46862),a(2585),a(85233),a(31369),a(7927),a(93216),a(74344),a(33371)],void 0===(o=function(e,t,n,o,s,i,r,c,l,d,m,u,p){const f={initialised:!1};let g=!1;return f.init=function(){const t=utils.findBootstrapEnvironment();f.initialised||(f.addSocketListeners(),f.addGlobalEventListeners()),o.init(),f.addEventListeners(),f.setActive(),"md"!==t&&"lg"!==t||f.addHotkeys(),$(document).ready((function(){c.fire("action:chat.loaded",$(".chats-full"))})),f.initialised=!0,i.scrollToBottom($(".expanded-chat ul.chat-content")),s.init(),ajaxify.data.hasOwnProperty("roomId")&&e.get("chat/input").focus()},f.addEventListeners=function(){f.addSendHandlers(ajaxify.data.roomId,$(".chat-input"),$('.expanded-chat button[data-action="send"]')),f.addPopoutHandler(),f.addActionHandlers(e.get("chat/messages"),ajaxify.data.roomId),f.addMemberHandler(ajaxify.data.roomId,e.get("chat/controls").find('[data-action="members"]')),f.addRenameHandler(ajaxify.data.roomId,e.get("chat/controls").find('[data-action="rename"]')),f.addLeaveHandler(ajaxify.data.roomId,e.get("chat/controls").find('[data-action="leave"]')),f.addScrollHandler(ajaxify.data.roomId,ajaxify.data.uid,$(".chat-content")),f.addScrollBottomHandler($(".chat-content")),f.addCharactersLeftHandler($('[component="chat/main-wrapper"]')),f.addIPHandler($('[component="chat/main-wrapper"]')),f.createAutoComplete($('[component="chat/input"]')),f.addUploadHandler({dragDropAreaEl:$(".chats-full"),pasteEl:$('[component="chat/input"]'),uploadFormEl:$('[component="chat/upload"]'),inputEl:$('[component="chat/input"]')}),$('[data-action="close"]').on("click",(function(){f.switchChat()}))},f.addUploadHandler=function(e){p.init({dragDropAreaEl:e.dragDropAreaEl,pasteEl:e.pasteEl,uploadFormEl:e.uploadFormEl,route:"/api/post/upload",callback:function(t){const a=e.inputEl;let n=a.val();t.forEach((e=>{n=n+(n?"\n":"")+(e.isImage?"!":"")+`[${e.filename}](${e.url})`})),a.val(n)}})},f.addIPHandler=function(e){e.on("click",".chat-ip-button",(function(){const e=$(this).parent(),t=e.parents("[data-mid]").attr("data-mid");socket.emit("modules.chats.getIP",t,(function(t,a){if(t)return d.error(t);e.html(a)}))}))},f.addPopoutHandler=function(){$('[data-action="pop-out"]').on("click",(function(){const t=e.get("chat/input").val(),a=ajaxify.data.roomId;app.previousUrl&&app.previousUrl.match(/chats/)?ajaxify.go("user/"+ajaxify.data.userslug+"/chats",(function(){m.openChat(a,ajaxify.data.uid)}),!0):(window.history.go(-1),m.openChat(a,ajaxify.data.uid)),$(window).one("action:chat.loaded",(function(){e.get("chat/input").val(t)}))}))},f.addScrollHandler=function(e,t,a){let n=!1;a.off("scroll").on("scroll",(function(){if(i.toggleScrollUpAlert(a),n)return;const o=.1*(a[0].scrollHeight-a.height());if(a.scrollTop()>=o)return;n=!0;const s=parseInt(a.children("[data-mid]").length,10);u.get(`/chats/${e}/messages`,{uid:t,start:s}).then((e=>{(e=e.messages)&&(e=e.filter((function(e){return!$('[component="chat/message"][data-mid="'+e.messageId+'"]').length}))).length?i.parseMessage(e,(function(e){const t=a.scrollTop(),o=a[0].scrollHeight;e=$(e),a.prepend(e),e.find(".timeago").timeago(),e.find("img:not(.not-responsive)").addClass("img-responsive"),a.scrollTop(a[0].scrollHeight-o+t),n=!1})):n=!1})).catch(d.error)}))},f.addScrollBottomHandler=function(e){e.parent().find('[component="chat/messages/scroll-up-alert"]').off("click").on("click",(function(){i.scrollToBottom(e)}))},f.addCharactersLeftHandler=function(e){e.find('[component="chat/input"]').on("change keyup paste",(function(){i.updateRemainingLength(e)}))},f.addActionHandlers=function(e,t){e.on("click","[data-action]",(function(){const e=$(this).parents("[data-mid]").attr("data-mid");switch(this.getAttribute("data-action")){case"edit":{const a=$('[data-roomid="'+t+'"] [component="chat/input"]');i.prepEdit(a,e,t);break}case"delete":i.delete(e,t);break;case"restore":i.restore(e,t)}}))},f.addHotkeys=function(){n.bind("ctrl+up",(function(){const e=$(".chats-list .bg-info").prev();e.length&&f.switchChat(e.attr("data-roomid"))})),n.bind("ctrl+down",(function(){const e=$(".chats-list .bg-info").next();e.length&&f.switchChat(e.attr("data-roomid"))})),n.bind("up",(function(t){if(t.target===e.get("chat/input").get(0)){const t=e.get("chat/messages").find('.chat-message[data-self="1"]').last();if(!t.length)return;const a=t.attr("data-mid"),n=e.get("chat/input");i.prepEdit(n,a,ajaxify.data.roomId)}}))},f.addMemberHandler=function(e,t){let n;t.on("click",(function(){app.parseAndTranslate("partials/modals/manage_room",{},(function(t){n=l.dialog({title:"[[modules:chat.manage-room]]",message:t}),n.attr("component","chat/manage-modal"),f.refreshParticipantsList(e,n),f.addKickHandler(e,n);const o=n.find("input"),s=n.find(".text-danger");a.e(6193).then((function(){var t=[a(86193),a(32230)];(function(t,a){t.user(o,(function(t,i){s.text(""),u.post(`/chats/${e}/users`,{uids:[i.item.user.uid]}).then((t=>{f.refreshParticipantsList(e,n,t),o.val("")})).catch((e=>{a.translate(e.message,(function(e){s.text(e)}))}))}))}).apply(null,t)})).catch(a.oe)}))}))},f.addKickHandler=function(e,t){t.on("click",'[data-action="kick"]',(function(){const a=parseInt(this.getAttribute("data-uid"),10);u.delete(`/chats/${e}/users/${a}`,{}).then((a=>{f.refreshParticipantsList(e,t,a)})).catch(d.error)}))},f.addLeaveHandler=function(e,t){t.on("click",(function(){l.confirm({size:"small",title:"[[modules:chat.leave]]",message:'<p>[[modules:chat.leave-prompt]]</p><p class="help-block">[[modules:chat.leave-help]]</p>',callback:function(a){a&&u.delete(`/chats/${e}/users/${app.user.uid}`,{}).then((()=>{const e=t.parents(".chat-modal");e.length?m.close(e):ajaxify.go("chats")})).catch(d.error)}})}))},f.refreshParticipantsList=async(e,a,n)=>{const o=a.find(".list-group");if(!n)try{n=await u.get(`/chats/${e}/users`,{})}catch(e){t.translate("[[error:invalid-data]]",(function(e){o.find("li").text(e)}))}app.parseAndTranslate("partials/modals/manage_room_users",n,(function(e){o.html(e)}))},f.addRenameHandler=function(e,t,a){let n;function o(){u.put(`/chats/${e}`,{name:n.find("#roomName").val()}).catch(d.error)}t.on("click",(function(){app.parseAndTranslate("partials/modals/rename_room",{name:a||ajaxify.data.roomName},(function(e){n=l.dialog({title:"[[modules:chat.rename-room]]",message:e,buttons:{save:{label:"[[global:save]]",className:"btn-primary",callback:o}}})}))}))},f.addSendHandlers=function(e,t,a){t.off("keypress").on("keypress",(function(a){if(13===a.which&&!a.shiftKey)return i.sendMessage(e,t),!1})),a.off("click").on("click",(function(){return i.sendMessage(e,t),t.focus(),!1}))},f.createAutoComplete=function(e){if(!e.length)return;const t={element:e,strategies:[],options:{style:{"z-index":2e4,flex:0,top:"inherit"},placement:"top"}};$(window).trigger("chat:autocomplete:init",t),t.strategies.length&&r.setup(t)},f.leave=function(e){const t=e.attr("data-roomid");u.delete(`/chats/${t}/users/${app.user.uid}`,{}).then((()=>{parseInt(t,10)===parseInt(ajaxify.data.roomId,10)?ajaxify.go("user/"+ajaxify.data.userslug+"/chats"):e.remove();const a=m.getModal(t);a.length&&m.close(a)})).catch(d.error)},f.switchChat=function(t){t||(t="");const a="user/"+ajaxify.data.userslug+"/chats/"+t+window.location.search;self.fetch?fetch(config.relative_path+"/api/"+a,{credentials:"include"}).then((function(t){t.ok?t.json().then((function(t){app.parseAndTranslate("partials/chats/message-window",t,(function(n){e.get("chat/main-wrapper").html(n),n.find(".timeago").timeago(),ajaxify.data=t,f.setActive(),f.addEventListeners(),c.fire("action:chat.loaded",$(".chats-full")),i.scrollToBottom($(".expanded-chat ul.chat-content")),history.pushState&&history.pushState({url:a},null,window.location.protocol+"//"+window.location.host+config.relative_path+"/"+a)}))})):console.warn("[search] Received "+t.status)})).catch((function(e){console.warn("[search] "+e.message)})):ajaxify.go(a)},f.addGlobalEventListeners=function(){$(window).on("mousemove keypress click",(function(){g&&ajaxify.data.roomId&&(socket.emit("modules.chats.markRead",ajaxify.data.roomId),g=!1)}))},f.addSocketListeners=function(){socket.on("event:chats.receive",(function(t){if(parseInt(t.roomId,10)===parseInt(ajaxify.data.roomId,10))g=0===t.self,t.message.self=t.self,i.appendChatMessage($(".expanded-chat .chat-content"),t.message);else if(ajaxify.data.template.chats){const a=$("[data-roomid="+t.roomId+"]");if(a.length>0)a.addClass("unread");else{const a=e.get("chat/recent");app.parseAndTranslate("partials/chats/recent_room",{rooms:{roomId:t.roomId,lastUser:t.message.fromUser,usernames:t.message.fromUser.username,unread:!0}},(function(e){a.prepend(e)}))}}})),socket.on("event:user_status_change",(function(e){app.updateUserStatus($('.chats-list [data-uid="'+e.uid+'"] [component="user/status"]'),e.status)})),i.addSocketListeners(),socket.on("event:chats.roomRename",(function(t){const a=e.get("chat/recent/room",t.roomId).find('[component="chat/title"]');ajaxify.data.roomName=t.newName,a.text(t.newName)}))},f.setActive=function(){ajaxify.data.roomId&&(socket.emit("modules.chats.markRead",ajaxify.data.roomId),$('[data-roomid="'+ajaxify.data.roomId+'"]').toggleClass("unread",!1),$('.expanded-chat [component="chat/input"]').focus()),$(".chats-list li").removeClass("bg-info"),$('.chats-list li[data-roomid="'+ajaxify.data.roomId+'"]').addClass("bg-info"),e.get("chat/nav-wrapper").attr("data-loaded",ajaxify.data.roomId?"1":"0")},f}.apply(t,n))||(e.exports=o)},46862:(e,t,a)=>{var n,o;n=[a(7237),a(32230),a(59006),a(85233),a(31369),a(7927),a(44882),a(74344)],void 0===(o=function(e,t,a,n,o,s,i,r){const c={};function l(t){t.messages.forEach((function(t){const a=parseInt(t.fromuid,10)===parseInt(app.user.uid,10);t.self=a?1:0,c.parseMessage(t,(function(a){const n=e.get("chat/message",t.messageId);n.length&&(n.replaceWith(a),e.get("chat/message",t.messageId).find(".timeago").timeago())}))}))}function d(t){e.get("chat/message",t).toggleClass("deleted",!0).find('[component="chat/message/body"]').translateHtml("[[modules:chat.message-deleted]]")}function m(t){e.get("chat/message",t.messageId).toggleClass("deleted",!1).find('[component="chat/message/body"]').html(t.content)}return c.sendMessage=async function(e,t){let a=t.val(),o=t.attr("data-mid");if(!a.trim().length)return;t.val(""),t.removeAttr("data-mid"),c.updateRemainingLength(t.parent());const l={roomId:e,message:a,mid:o};n.fire("action:chat.sent",l),({roomId:e,message:a,mid:o}=await n.fire("filter:chat.send",l)),o?r.put(`/chats/${e}/messages/${o}`,{message:a}).catch((e=>(t.val(a),t.attr("data-mid",o),c.updateRemainingLength(t.parent()),s.error(e)))):r.post(`/chats/${e}`,{message:a}).catch((e=>(t.val(a),c.updateRemainingLength(t.parent()),"[[error:email-not-confirmed-chat]]"===e.message?i.showEmailConfirmWarning(e.message):s.alert({alert_id:"chat_spam_error",title:"[[global:alert.error]]",message:e.message,type:"danger",timeout:1e4}))))},c.updateRemainingLength=function(e){const t=e.find('[component="chat/input"]');e.find('[component="chat/message/length"]').text(t.val().length),e.find('[component="chat/message/remaining"]').text(config.maximumChatMessageLength-t.val().length),n.fire("action:chat.updateRemainingLength",{parent:e})},c.appendChatMessage=function(e,t){const a=parseInt(e.find(".chat-message").last().attr("data-uid"),10),o=parseInt(e.find(".chat-message").last().attr("data-timestamp"),10);Array.isArray(t)||(t.newSet=a!==parseInt(t.fromuid,10)||parseInt(t.timestamp,10)>parseInt(o,10)+18e4),c.parseMessage(t,(function(t){!function(e,t){const a=$(t),o=c.isAtBottom(e);a.appendTo(e),a.find(".timeago").timeago(),a.find("img:not(.not-responsive)").addClass("img-responsive"),o&&c.scrollToBottom(e),n.fire("action:chat.received",{messageEl:a})}(e,t)}))},c.parseMessage=function(e,n){function o(e){t.translate(e,n)}Array.isArray(e)?a.render("partials/chats/message"+(Array.isArray(e)?"s":""),{messages:e}).then(o):a.render("partials/chats/"+(e.system?"system-message":"message"),{messages:e}).then(o)},c.isAtBottom=function(e,t){if(e.length)return e[0].scrollHeight-(e.outerHeight()+e.scrollTop())<(t||100)},c.scrollToBottom=function(e){e&&e.length&&(e.scrollTop(e[0].scrollHeight-e.height()),e.parent().find('[component="chat/messages/scroll-up-alert"]').addClass("hidden"))},c.toggleScrollUpAlert=function(e){const t=c.isAtBottom(e,300);e.parent().find('[component="chat/messages/scroll-up-alert"]').toggleClass("hidden",t)},c.prepEdit=function(e,t,a){socket.emit("modules.chats.getRaw",{mid:t,roomId:a},(function(o,i){if(o)return s.error(o);0===e.val().length&&(e.attr("data-mid",t).addClass("editing"),e.val(i).focus(),n.fire("action:chat.prepEdit",{inputEl:e,messageId:t,roomId:a}))}))},c.addSocketListeners=function(){socket.removeListener("event:chats.edit",l),socket.on("event:chats.edit",l),socket.removeListener("event:chats.delete",d),socket.on("event:chats.delete",d),socket.removeListener("event:chats.restore",m),socket.on("event:chats.restore",m)},c.delete=function(a,n){t.translate("[[modules:chat.delete_message_confirm]]",(function(t){o.confirm(t,(function(t){t&&r.delete(`/chats/${n}/messages/${a}`,{}).then((()=>{e.get("chat/message",a).toggleClass("deleted",!0)})).catch(s.error)}))}))},c.restore=function(t,a){r.post(`/chats/${a}/messages/${t}`,{}).then((()=>{e.get("chat/message",t).toggleClass("deleted",!1)})).catch(s.error)},c}.apply(t,n))||(e.exports=o)},2585:(e,t,a)=>{var n,o;n=[a(83713),a(70675),a(88207),a(62336)],void 0===(o=function(e,{Textcomplete:t},{TextareaEditor:a},{ContenteditableEditor:n}){var o={_active:{}};return $(window).on("action:composer.discard",(function(e,t){o._active.hasOwnProperty(t.post_uuid)&&(o._active[t.post_uuid].destroy(),delete o._active[t.post_uuid])})),o.init=function(t,a){var n,s=t.find(".write"),i="composer-autocomplete-dropdown-"+a;if(s.length){var r={element:s,strategies:[],options:{style:{"z-index":2e4},className:i+" dropdown-menu textcomplete-dropdown"}};s.on("keyup",(function(){clearTimeout(n),n=setTimeout((function(){var e=document.querySelector("."+i);if(e){var t=e.getBoundingClientRect(),a=parseFloat(e.style.marginTop,10)||0,n=window.innerHeight+a-10-t.bottom;e.style.marginTop=Math.min(n,0)+"px"}}),0)})),$(window).trigger("composer:autocomplete:init",r),o._active[a]=o.setup(r),r.element.on("textComplete:select",(function(){e.render(t)}))}},o.setup=function({element:e,strategies:o,options:s}){const i=e.get(0);if(i){var r;"TEXTAREA"===i.nodeName?r=new a(i):"DIV"===i.nodeName&&"true"===i.getAttribute("contenteditable")&&(r=new n(i)),i.setAttribute("dir",document.querySelector("html").getAttribute("data-dir"));var c=new t(r,o,{dropdown:s});return c.on("rendered",(function(){c.dropdown.items.length&&c.dropdown.items[0].activate()})),c}},o}.apply(t,n))||(e.exports=o)},83713:(e,t,a)=>{var n,o;n=[a(85233)],void 0===(o=function(e){var t={render:function(t,a){if(a=a||function(){},!t.find(".preview-container").is(":visible"))return a();var n=t.find("textarea");socket.emit("plugins.composer.renderPreview",n.val(),(function(n,o){n||((o=$("<div>"+o+"</div>")).find("img:not(.not-responsive)").addClass("img-responsive"),t.find(".preview").html(o),e.fire("action:composer.preview"),a())}))},matchScroll:function(e){if(e.find(".preview-container").is(":visible")){var t=e.find("textarea"),a=e.find(".preview");if(t.length&&a.length){var n=t[0].scrollHeight-t.height();if(0===n)return;var o=t.scrollTop()/n;a.scrollTop(Math.max(a[0].scrollHeight-a.height(),0)*o)}}},handleToggler:function(e){t.env=utils.findBootstrapEnvironment();var a=e.find(".write-container .toggle-preview"),n=e.find(".preview-container .toggle-preview"),o=$(".preview-container"),s=$(".write-container");function i(){c(!1),"xs"!==t.env&&"sm"!==t.env&&localStorage.setItem("composer:previewToggled",!0)}function r(){c(!0),"xs"!==t.env&&"sm"!==t.env&&localStorage.removeItem("composer:previewToggled")}function c(n){"xs"===t.env||"sm"===t.env?(o.toggleClass("hide",!1),s.toggleClass("maximized",!1),a.toggleClass("hide",!0),o.toggleClass("hidden-xs hidden-sm",!n),s.toggleClass("hidden-xs hidden-sm",n),n&&t.render(e)):(o.toggleClass("hide",!n),s.toggleClass("maximized",!n),a.toggleClass("hide",n)),t.matchScroll(e)}t.toggle=c,n.on("click",(function(){i(),e.find(".write").focus()})),a.on("click",(function(){r(),e.find(".write").focus()})),localStorage.getItem("composer:previewToggled")||"xs"===t.env||"sm"===t.env?i():r()}};return t}.apply(t,n))||(e.exports=o)},44882:(e,t,a)=>{var n,o;n=[a(31369),a(32230),a(66603),a(7927),a(85233)],void 0===(o=function(e,t,a,n,o){const s={};let i,r;return s.show=function(){o.one("action:ajaxify.end",(()=>{!function(){const t=utils.params({full:!0});i=t.has("loggedin"),r=t.get("register"),i&&(n.alert({type:"success",title:"[[global:welcome_back]] "+app.user.username+"!",message:"[[global:you_have_successfully_logged_in]]",timeout:5e3}),t.delete("loggedin")),r&&(e.alert({message:utils.escapeHTML(decodeURIComponent(r))}),t.delete("register"));const a=t.toString();ajaxify.updateHistory(ajaxify.currentPage+(a?`?${a}`:"")+document.location.hash,!0)}(),config.cookies.enabled&&navigator.cookieEnabled&&!app.inAdmin&&"1"!==a.getItem("cookieconsent")&&(config.cookies.message=t.unescape(config.cookies.message),config.cookies.dismiss=t.unescape(config.cookies.dismiss),config.cookies.link=t.unescape(config.cookies.link),config.cookies.link_url=t.unescape(config.cookies.link_url),app.parseAndTranslate("partials/cookie-consent",config.cookies,(function(e){$(document.body).append(e),$(document.body).addClass("cookie-consent-open");const t=$(".cookie-consent");t.find("button").on("click",(function(){a.setItem("cookieconsent","1"),t.remove(),$(document.body).removeClass("cookie-consent-open")}))}))),s.showEmailConfirmWarning()}))},s.showEmailConfirmWarning=function(e){if(!config.emailPrompt||!app.user.uid||1===parseInt(a.getItem("email-confirm-dismiss"),10))return;const t={alert_id:"email_confirm",type:"warning",timeout:0,closefn:()=>{a.setItem("email-confirm-dismiss",1)}};app.user.email?app.user["email:confirmed"]||app.user.isEmailConfirmSent?!app.user["email:confirmed"]&&app.user.isEmailConfirmSent&&(t.message="[[error:email-not-confirmed-email-sent]]",n.alert(t)):(t.message=e||"[[error:email-not-confirmed]]",t.clickfn=function(){n.remove("email_confirm"),socket.emit("user.emailConfirm",{},(function(e){if(e)return n.error(e);n.success("[[notifications:email-confirm-sent]]")}))},n.alert(t)):(t.message="[[error:no-email-to-confirm]]",t.clickfn=function(){n.remove("email_confirm"),ajaxify.go("user/"+app.user.userslug+"/edit/email")},n.alert(t))},s.showInvalidSession=function(){e.alert({title:"[[error:invalid-session]]",message:"[[error:invalid-session-text]]",closeButton:!1,callback:function(){window.location.reload()}})},s.showSessionMismatch=function(){e.alert({title:"[[error:session-mismatch]]",message:"[[error:session-mismatch-text]]",closeButton:!1,callback:function(){window.location.reload()}})},s}.apply(t,n))||(e.exports=o)},66603:(e,t,a)=>{var n;void 0===(n=function(){function e(){this._store={},this._keys=[]}let t;e.prototype.isMock=!0,e.prototype.setItem=function(e,t){e=String(e),-1===this._keys.indexOf(e)&&this._keys.push(e),this._store[e]=t},e.prototype.getItem=function(e){return e=String(e),-1===this._keys.indexOf(e)?null:this._store[e]},e.prototype.removeItem=function(e){e=String(e),this._keys=this._keys.filter((function(t){return t!==e})),this._store[e]=null},e.prototype.clear=function(){this._keys=[],this._store={}},e.prototype.key=function(e){return e=parseInt(e,10)||0,this._keys[e]},Object.defineProperty&&Object.defineProperty(e.prototype,"length",{get:function(){return this._keys.length}});const a=Date.now().toString();try{if(t=window.localStorage,t.setItem(a,a),t.getItem(a)!==a)throw Error("localStorage behaved unexpectedly");return t.removeItem(a),t}catch(n){console.warn(n),console.warn("localStorage failed, falling back on sessionStorage");try{if(t=window.sessionStorage,t.setItem(a,a),t.getItem(a)!==a)throw Error("sessionStorage behaved unexpectedly");return t.removeItem(a),t}catch(t){return console.warn(t),console.warn("sessionStorage failed, falling back on memory storage"),new e}}}.call(t,a,t,e))||(e.exports=n)},33371:(e,t,a)=>{var n,o;n=[a(7927)],void 0===(o=function(e){const t={init:function(e){const a=e.uploadFormEl;a.length&&(a.attr("action",config.relative_path+e.route),e.dragDropAreaEl&&t.handleDragDrop({container:e.dragDropAreaEl,callback:function(n){t.ajaxSubmit({uploadForm:a,upload:n,callback:e.callback})}}),e.pasteEl&&t.handlePaste({container:e.pasteEl,callback:function(n){t.ajaxSubmit({uploadForm:a,upload:n,callback:e.callback})}}))},handleDragDrop:function(e){let t=!1;const a=e.container,n=e.container.find(".imagedrop");function o(e){return e.preventDefault(),!1}a.on("dragenter",(function(){t||(n.css("top","0px"),n.css("height",a.height()+"px"),n.css("line-height",a.height()+"px"),n.show(),n.on("dragleave",(function(){n.hide(),n.off("dragleave")})))})),n.on("drop",(function(t){t.preventDefault();const a=t.originalEvent.dataTransfer.files;if(a.length){let t;if(window.FormData){t=new FormData;for(var o=0;o<a.length;++o)t.append("files[]",a[o],a[o].name)}e.callback({files:a,formData:t})}return n.hide(),!1})),$(document).off("dragstart").on("dragstart",(function(){t=!0})).off("dragend").on("dragend, mouseup",(function(){t=!1})),n.on("dragover",o),n.on("dragenter",o)},handlePaste:function(e){e.container.on("paste",(function(t){const a=(t.clipboardData||t.originalEvent.clipboardData||{}).items,n=[],o=[];let s=null;window.FormData&&(s=new FormData),[].forEach.call(a,(function(e){const t=e.getAsFile();if(t){const e=utils.generateUUID()+"-"+t.name;s&&s.append("files[]",t,e),n.push(t),o.push(e)}})),n.length&&e.callback({files:n,fileNames:o,formData:s})}))},ajaxSubmit:function(t){const a=[...t.upload.files];for(let n=0;n<a.length;++n){const o=a[n].type.match(/image./);if(o&&!app.user.privileges["upload:post:image"]||!o&&!app.user.privileges["upload:post:file"])return e.error("[[error:no-privileges]]");if(a[n].size>1024*parseInt(config.maximumFileSize,10))return t.uploadForm[0].reset(),e.error("[[error:file-too-big, "+config.maximumFileSize+"]]")}const n=Date.now();t.uploadForm.off("submit").on("submit",(function(){return $(this).ajaxSubmit({headers:{"x-csrf-token":config.csrf_token},resetForm:!0,clearForm:!0,formData:t.upload.formData,error:function(t){let a=t.responseJSON&&(t.responseJSON.error||t.responseJSON.status&&t.responseJSON.status.message)||"[[error:parse-error]]";t&&413===t.status&&(a=t.statusText||"Request Entity Too Large"),e.error(a),e.remove(n)},uploadProgress:function(t,a,o,s){e.alert({alert_id:n,message:"[[modules:composer.uploading, "+s+"%]]"})},success:function(e){const n=e.response.images;if(n&&n.length)for(var o=0;o<n.length;++o)n[o].filename=a[o].name,n[o].isImage=/image./.test(a[o].type);t.callback(n)},complete:function(){t.uploadForm[0].reset(),setTimeout(e.remove,100,n)}}),!1})),t.uploadForm.submit()}};return t}.apply(t,n))||(e.exports=o)}}]);